app-id: io.github.OpenToonz
default-branch: stable
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: opentoonz
finish-args:
  - --socket=wayland
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=host
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib/opentoonz
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.a'
  - '*.la'
modules:     
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json
  - shared-modules/intltool/intltool-0.51.json

  - name: libusb
    config-opts:
      - --disable-static
      - --disable-udev
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/releases/download/v1.0.23/libusb-1.0.23.tar.bz2
        sha256: db11c06e958a82dac52cf3c65cb4dd2c3f339c8a988665110e0d24d19312ad8d

  - name: freeglut
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    build-options: # https://wiki.gentoo.org/wiki/Gcc_10_porting_notes/fno_common
      cflags: -fcommon
      cxxflags: -fcommon
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/freeglut/freeglut/3.2.1/freeglut-3.2.1.tar.gz
        sha256: d4000e02102acaf259998c870e25214739d1f16f67f99cb35e4f46841399da68

  - name: superlu
    buildsystem: cmake # ninja broken
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_POSITION_INDEPENDENT_CODE=True
    sources:
      - type: archive
        url: https://github.com/xiaoyeli/superlu/archive/v5.2.1.tar.gz
        sha256: 77582501dedef295eb74e4dc9433e2816d2d8be211eae307379c13d93c65bc71

  - name: OpenBLAS
    buildsystem: cmake # fortran needs ninja 1.10
    builddir: true
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.9.tar.gz
        sha256: 17d4677264dfbc4433e97076220adc79b050e4f8a083ea3f853a53af253bc380

  - name: lz4
    buildsystem: cmake-ninja
    builddir: true
    subdir: contrib/cmake_unofficial
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/lz4/lz4/archive/v1.9.2.tar.gz
        sha256: 658ba6191fa44c92280d4aa2c271b0f4fbc0e34d249578dd05e50e76d0e5efcc

  - name: lzo
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: archive
        url: https://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz
        sha256: c0f892943208266f9b6543b3ae308fab6284c5c90e627931446fb49b4221a072

  - name: json-c
    sources:
      - type: archive
        url: https://github.com/json-c/json-c/archive/json-c-0.13.1-20180305.tar.gz
        sha256: 5d867baeb7f540abe8f3265ac18ed7a24f91fe3c5f4fd99ac3caba0708511b90

  - name: libmypaint
    config-opts:
      - --disable-gegl
      - --disable-introspection
    sources:
      - type: archive
        url: https://github.com/mypaint/libmypaint/releases/download/v1.5.1/libmypaint-1.5.1.tar.xz
        sha256: aef8150a0c84ce2ff6fb24de8d5ffc564845d006f8bad7ed84ee32ed1dd90c2b

  - name: boost
    buildsystem: simple
    build-commands:
      - mkdir -p /app/include/boost
      - mv -t /app/include/boost *
    sources:
      - type: archive
        url: https://dl.bintray.com/boostorg/release/1.72.0/source/boost_1_72_0.tar.bz2
        sha256: 59c9b274bc451cf91a9ba1dd2c7fdcaf5d60b1b3aa83f2c9fa143417cc660722

  - name: 'x264'
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://code.videolan.org/videolan/x264/-/archive/1771b556ee45207f8711744ccbd5d42a3949b14c/x264-1771b556ee45207f8711744ccbd5d42a3949b14c.tar.bz2
        sha256: b31c5db5337873b9ee42b8cbc60b56d60ce368fa7e4c4eff90a729b36eeb8326

  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --disable-static
      - --enable-shared
      - --disable-doc
      - --disable-ffplay
      - --disable-ffprobe
      - --enable-libopus
      - --enable-libvpx
      - --enable-libx264
    cleanup:
      - /share/ffmpeg/examples
    sources:
      - type: archive
        url: https://www.ffmpeg.org/releases/ffmpeg-4.2.2.tar.xz
        sha256: cb754255ab0ee2ea5f66f8850e1bd6ad5cac1cd855d0a2f4990fb8c668b0d29c

  - name: opentoonz
    buildsystem: cmake
    builddir: true
    subdir: toonz/sources
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBOOST_ROOT=/app/include/boost
    post-install:
      - sed -i '/LD_LIBRARY_PATH/d' /app/bin/opentoonz
    sources:
      - type: archive
        url: https://github.com/opentoonz/opentoonz/archive/v1.4.0.tar.gz
        sha256: 176caca191bf2747964ecaf8cbb6be6a738fd04b464a2ba182b5aaf96ccaefa9
      - type: patch
        path: opentoonz-twain.patch
      - type: shell
        commands:
          - cd thirdparty/tiff-4.0.3 &&
            cp -p /usr/share/automake-*/config.{sub,guess} config &&
            ./configure --with-pic --disable-jbig &&
            make -j $FLATPAK_BUILDER_N_JOBS
