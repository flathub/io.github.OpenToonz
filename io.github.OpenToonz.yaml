app-id: io.github.OpenToonz
branch: stable
runtime: org.kde.Platform
runtime-version: '5.12'
sdk: org.kde.Sdk
command: opentoonz
finish-args:
  - --socket=wayland
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=host
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib/opentoonz
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.a'
  - '*.la'
modules:     
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.0.0.json

  - name: libusb
    config-opts:
      - --disable-static
      - --disable-udev
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/releases/download/v1.0.23/libusb-1.0.23.tar.bz2
        sha256: db11c06e958a82dac52cf3c65cb4dd2c3f339c8a988665110e0d24d19312ad8d

  - name: freeglut
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/freeglut/freeglut/3.0.0/freeglut-3.0.0.tar.gz
        sha256: 2a43be8515b01ea82bcfa17d29ae0d40bd128342f0930cd1f375f1ff999f76a2

  - name: superlu
    buildsystem: cmake # ninja broken
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_POSITION_INDEPENDENT_CODE=True
    sources:
      - type: archive
        url: https://github.com/xiaoyeli/superlu/archive/v5.2.1.tar.gz
        sha256: 77582501dedef295eb74e4dc9433e2816d2d8be211eae307379c13d93c65bc71

  - name: openblas
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - FC=gfortran
      - NO_LAPACKE=1
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.5.tar.gz
        sha256: 0950c14bd77c90a6427e26210d6dab422271bc86f9fc69126725833ecdaa0e85

  - name: lz4
    buildsystem: cmake-ninja
    builddir: true
    subdir: contrib/cmake_unofficial
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/lz4/lz4/archive/v1.8.3.tar.gz
        sha256: 33af5936ac06536805f9745e0b6d61da606a1f8b4cc5c04dd3cbaca3b9b4fc43

  - name: lzo
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: archive
        url: https://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz
        sha256: c0f892943208266f9b6543b3ae308fab6284c5c90e627931446fb49b4221a072

  - name: json-c
    sources:
      - type: archive
        url: https://github.com/json-c/json-c/archive/json-c-0.13.1-20180305.tar.gz
        sha256: 5d867baeb7f540abe8f3265ac18ed7a24f91fe3c5f4fd99ac3caba0708511b90

  - name: libmypaint
    config-opts:
      - --disable-gegl
      - --disable-introspection
    sources:
      - type: archive
        url: https://github.com/mypaint/libmypaint/releases/download/v1.4.0/libmypaint-1.4.0.tar.xz
        sha256: 59d13b14c6aca0497095f29ee7228ca2499a923ba8e1dd718a2f2ecb45a9cbff

  - name: boost
    buildsystem: simple
    build-commands:
      - mkdir -p /app/boost
      - mv -t /app/boost *
    cleanup:
      - /boost
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/boost/boost/1.61.0/boost_1_61_0.tar.bz2
        sha256: a547bd06c2fd9a71ba1d169d9cf0339da7ebf4753849a8f7d6fdb8feee99b640

  - name: 'x264'
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20180807-2245-stable.tar.bz2
        sha256: 1439f1a054c87965089b646e77d16e1a8bf2f9687e4dd696ac518e44c7644c2a

  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --disable-static
      - --enable-shared
      - --disable-doc
      - --disable-ffplay
      - --disable-ffprobe
      - --enable-libopus
      - --enable-libvpx
      - --enable-libx264
    cleanup:
      - /share/ffmpeg/examples
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-4.0.3.tar.xz
        sha256: 253c37e3f1d3626a2566e496554de9a4c29050753660835909a466d66b12e2ed

  - name: opentoonz
    buildsystem: cmake-ninja
    builddir: true
    subdir: toonz/sources
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBOOST_ROOT=/app/boost
    post-install:
      - sed -i '/LD_LIBRARY_PATH/d' /app/bin/opentoonz
    sources:
      - type: archive
        url: https://github.com/opentoonz/opentoonz/archive/v1.4.0.tar.gz
        sha256: 176caca191bf2747964ecaf8cbb6be6a738fd04b464a2ba182b5aaf96ccaefa9
      - type: shell
        commands:
          - cd thirdparty/tiff-4.0.3 &&
            cp -p /usr/share/automake-*/config.{sub,guess} config &&
            ./configure --with-pic --disable-jbig &&
            make -j $FLATPAK_BUILDER_N_JOBS
